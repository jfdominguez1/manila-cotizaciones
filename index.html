<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cotizaciones Manila</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="topnav">
  <img src="img/logo-manila.png" alt="Manila" class="nav-logo">
  <span class="nav-title">Cotizaciones</span>
  <div class="nav-links">
    <a href="index.html" class="active">Dashboard</a>
    <a href="quote.html">Nueva Cotizaci√≥n</a>
    <a href="history.html">Historial</a>
    <a href="admin.html">Admin</a>
    <a href="seed.html">Datos de ejemplo</a>
  </div>
  <div class="nav-right">
    <span class="nav-version">v1.6</span>
    <span class="nav-user" id="nav-user"></span>
    <button class="btn-logout" id="btn-logout">Salir</button>
  </div>
</nav>

<div class="dashboard-page">
  <h1>Dashboard</h1>
  <p class="dash-sub" id="dash-greeting">Bienvenido al sistema de cotizaciones Manila S.A.</p>

  <div class="dash-cards">
    <a href="quote.html" class="dash-card">
      <div class="dash-card-icon">‚úèÔ∏è</div>
      <div class="dash-card-title">Nueva cotizaci√≥n</div>
      <div class="dash-card-desc">Construir una cotizaci√≥n nueva con c√°lculo de costos y m√°rgenes en tiempo real.</div>
    </a>
    <a href="history.html" class="dash-card">
      <div class="dash-card-icon">üìã</div>
      <div class="dash-card-title">Historial</div>
      <div class="dash-card-desc">Consultar cotizaciones confirmadas y borradores. Abrir como modelo para duplicar.</div>
    </a>
    <a href="admin.html" class="dash-card">
      <div class="dash-card-icon">‚öôÔ∏è</div>
      <div class="dash-card-title">Administraci√≥n</div>
      <div class="dash-card-desc">Gestionar cat√°logo de productos y tablas de costos de referencia.</div>
    </a>
  </div>

  <!-- √öltimas cotizaciones -->
  <div class="dash-section-title">
    √öltimas cotizaciones
    <a href="history.html">Ver todas ‚Üí</a>
  </div>
  <div id="recent-quotes">
    <div class="empty-state"><p>Cargando...</p></div>
  </div>

  <!-- Stats r√°pidas -->
  <div class="dash-section-title" style="margin-top:32px">Resumen</div>
  <div class="dash-cards" id="stats-cards" style="margin-bottom:0">
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">‚úÖ</div>
      <div class="dash-card-title" id="stat-confirmed">‚Äî</div>
      <div class="dash-card-desc">Cotizaciones confirmadas</div>
    </div>
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">üìù</div>
      <div class="dash-card-title" id="stat-drafts">‚Äî</div>
      <div class="dash-card-desc">Borradores pendientes</div>
    </div>
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">üì¶</div>
      <div class="dash-card-title" id="stat-products">‚Äî</div>
      <div class="dash-card-desc">Productos en cat√°logo</div>
    </div>
  </div>

</div>

<script type="module">
  import { requireAuth, logout } from './js/auth.js';
  import { db } from './js/firebase.js';
  import { collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

  async function init() {
    const user = await requireAuth();
    document.getElementById('nav-user').textContent = user.email;
    document.getElementById('btn-logout').addEventListener('click', logout);
    document.getElementById('dash-greeting').textContent =
      `Hola, ${user.email.split('@')[0]} ‚Äî ${new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}`;

    const [quotesSnap, productsSnap] = await Promise.all([
      getDocs(query(collection(db, 'quotes'), orderBy('created_at', 'desc'))),
      getDocs(collection(db, 'products'))
    ]);

    const quotes = quotesSnap.docs.map(d => d.data());
    const confirmed = quotes.filter(q => q.status === 'confirmed').length;
    const drafts = quotes.filter(q => q.status === 'draft').length;

    document.getElementById('stat-confirmed').textContent = confirmed;
    document.getElementById('stat-drafts').textContent = drafts;
    document.getElementById('stat-products').textContent = productsSnap.size;

    // √öltimas 6 cotizaciones
    const recent = quotes.slice(0, 6);
    const container = document.getElementById('recent-quotes');
    if (!recent.length) {
      container.innerHTML = `<div class="empty-state"><p>No hay cotizaciones todav√≠a. <a href="quote.html">Crear la primera ‚Üí</a></p></div>`;
      return;
    }

    const table = document.createElement('table');
    table.className = 'quotes-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Producto</th>
          <th>Incoterm</th>
          <th>Precio/kg</th>
          <th>Precio/lb</th>
          <th>Estado</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    recent.forEach(q => {
      const tr = document.createElement('tr');
      const dateStr = q.created_at
        ? new Date(q.created_at).toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' })
        : '‚Äî';
      tr.innerHTML = `
        <td class="quote-number">${q.quote_number ?? '‚Äî'}</td>
        <td>${dateStr}</td>
        <td>${q.client?.name ?? '‚Äî'}</td>
        <td>${q.product?.name ?? '‚Äî'}</td>
        <td><strong>${q.incoterm ?? '‚Äî'}</strong></td>
        <td class="num">$${(q.price_per_kg ?? 0).toFixed(2)}</td>
        <td class="num">$${(q.price_per_lb ?? 0).toFixed(2)}</td>
        <td><span class="status-badge ${q.status}">${q.status === 'confirmed' ? 'Confirmada' : 'Borrador'}</span></td>
        <td>
          <a href="history.html" style="font-size:12px;color:var(--accent);text-decoration:none">Ver ‚Üí</a>
        </td>
      `;
      tbody.appendChild(tr);
    });
    container.innerHTML = '';
    container.appendChild(table);
  }

  init();
</script>

</body>
</html>
