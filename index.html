<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cotizaciones Manila</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='85'>üêü</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="topnav">
  <img src="img/logo-manila.png" alt="Manila" class="nav-logo">
  <span class="nav-title">Cotizaciones</span>
  <div class="nav-links">
    <a href="index.html" class="active">Dashboard</a>
    <div class="nav-dropdown">
      <button class="nav-dropdown-label">Export <span class="nav-dropdown-arrow">‚ñæ</span></button>
      <div class="nav-dropdown-menu">
        <a href="quote.html">Nueva Export</a>
        <a href="history.html">Historial Export</a>
      </div>
    </div>
    <div class="nav-dropdown">
      <button class="nav-dropdown-label">Local <span class="nav-dropdown-arrow">‚ñæ</span></button>
      <div class="nav-dropdown-menu">
        <a href="quote-local.html">Nueva Local</a>
        <a href="history-local.html">Historial Local</a>
      </div>
    </div>
    <a href="admin.html">Admin</a>
  </div>
  <div class="nav-right">
    <span class="nav-version">v2.3.1</span>
    <span class="nav-user" id="nav-user"></span>
    <button class="btn-logout" id="btn-logout">Salir</button>
  </div>
</nav>

<div class="dashboard-page">
  <h1>Dashboard</h1>
  <p class="dash-sub" id="dash-greeting">Bienvenido al sistema de cotizaciones Manila S.A.</p>

  <div class="dash-cards">
    <a href="quote.html" class="dash-card">
      <div class="dash-card-icon">‚úèÔ∏è</div>
      <div class="dash-card-title">Nueva Export</div>
      <div class="dash-card-desc">Cotizaci√≥n de exportaci√≥n en USD con Incoterms y log√≠stica internacional.</div>
    </a>
    <a href="quote-local.html" class="dash-card">
      <div class="dash-card-icon">üè†</div>
      <div class="dash-card-title">Nueva Local</div>
      <div class="dash-card-desc">Cotizaci√≥n mercado local en ARS con condiciones de entrega y pago.</div>
    </a>
    <a href="admin.html" class="dash-card">
      <div class="dash-card-icon">‚öôÔ∏è</div>
      <div class="dash-card-title">Administraci√≥n</div>
      <div class="dash-card-desc">Gestionar cat√°logo de productos (export + local) y tablas de costos.</div>
    </a>
  </div>

  <!-- √öltimas cotizaciones EXPORT -->
  <div class="dash-section-title">
    √öltimas cotizaciones ‚Äî Export <span class="dash-section-badge export">USD</span>
    <a href="history.html">Ver todas ‚Üí</a>
  </div>
  <div id="recent-quotes-export">
    <div class="empty-state"><p>Cargando...</p></div>
  </div>

  <!-- √öltimas cotizaciones LOCAL -->
  <div class="dash-section-title" style="margin-top:28px">
    √öltimas cotizaciones ‚Äî Local <span class="dash-section-badge local">ARS</span>
    <a href="history-local.html">Ver todas ‚Üí</a>
  </div>
  <div id="recent-quotes-local">
    <div class="empty-state"><p>Cargando...</p></div>
  </div>

  <!-- Stats r√°pidas -->
  <div class="dash-section-title" style="margin-top:32px">Resumen</div>
  <div class="dash-cards" id="stats-cards" style="margin-bottom:0">
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">‚úÖ</div>
      <div class="dash-card-title" id="stat-confirmed">‚Äî</div>
      <div class="dash-card-desc">Cotizaciones confirmadas (total)</div>
    </div>
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">üìù</div>
      <div class="dash-card-title" id="stat-drafts">‚Äî</div>
      <div class="dash-card-desc">Borradores pendientes (total)</div>
    </div>
    <div class="dash-card" style="cursor:default">
      <div class="dash-card-icon">üì¶</div>
      <div class="dash-card-title" id="stat-products">‚Äî</div>
      <div class="dash-card-desc">Productos en cat√°logo (export + local)</div>
    </div>
  </div>

</div>

<script type="module">
  import { requireAuth, logout } from './js/auth.js';
  import { db } from './js/firebase.js';
  import { collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

  async function init() {
    const user = await requireAuth();
    document.getElementById('nav-user').textContent = user.email;
    document.getElementById('btn-logout').addEventListener('click', logout);
    document.getElementById('dash-greeting').textContent =
      `Hola, ${user.email.split('@')[0]} ‚Äî ${new Date().toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })}`;

    const [quotesSnap, quotesLocalSnap, productsSnap, productsLocalSnap] = await Promise.all([
      getDocs(query(collection(db, 'quotes'), orderBy('created_at', 'desc'))),
      getDocs(query(collection(db, 'quotes-local'), orderBy('created_at', 'desc'))),
      getDocs(collection(db, 'products')),
      getDocs(collection(db, 'products-local'))
    ]);

    const quotes = quotesSnap.docs.map(d => d.data());
    const quotesLocal = quotesLocalSnap.docs.map(d => d.data());

    const allQuotes = [...quotes, ...quotesLocal];
    const confirmed = allQuotes.filter(q => q.status === 'confirmed').length;
    const drafts = allQuotes.filter(q => q.status === 'draft').length;

    document.getElementById('stat-confirmed').textContent = confirmed;
    document.getElementById('stat-drafts').textContent = drafts;
    document.getElementById('stat-products').textContent = productsSnap.size + productsLocalSnap.size;

    // √öltimas 5 export
    renderRecentExport(quotes.slice(0, 5));

    // √öltimas 5 local
    renderRecentLocal(quotesLocal.slice(0, 5));
  }

  function renderRecentExport(recent) {
    const container = document.getElementById('recent-quotes-export');
    if (!recent.length) {
      container.innerHTML = `<div class="empty-state"><p>No hay cotizaciones export. <a href="quote.html">Crear la primera ‚Üí</a></p></div>`;
      return;
    }

    const table = document.createElement('table');
    table.className = 'quotes-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>Alias</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Producto</th>
          <th>Incoterm</th>
          <th>USD/kg</th>
          <th>USD/lb</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    recent.forEach(q => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      const dateStr = q.created_at
        ? new Date(q.created_at).toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' })
        : '‚Äî';
      tr.innerHTML = `
        <td class="quote-number">${q.quote_number ?? '‚Äî'}</td>
        <td class="text-small text-muted">${q.alias || '‚Äî'}</td>
        <td>${dateStr}</td>
        <td>${q.client?.name ?? '‚Äî'}</td>
        <td>${q.product?.name ?? '‚Äî'}</td>
        <td><strong>${q.incoterm ?? '‚Äî'}</strong></td>
        <td class="num">$${(q.price_per_kg ?? 0).toFixed(2)}</td>
        <td class="num">$${(q.price_per_lb ?? 0).toFixed(2)}</td>
        <td><span class="status-badge ${q.status}">${q.status === 'confirmed' ? 'Confirmada' : 'Borrador'}</span></td>
      `;
      tr.addEventListener('click', () => { window.location.href = 'history.html'; });
      tbody.appendChild(tr);
    });
    container.innerHTML = '';
    container.appendChild(table);
  }

  function renderRecentLocal(recent) {
    const container = document.getElementById('recent-quotes-local');
    if (!recent.length) {
      container.innerHTML = `<div class="empty-state"><p>No hay cotizaciones locales. <a href="quote-local.html">Crear la primera ‚Üí</a></p></div>`;
      return;
    }

    const table = document.createElement('table');
    table.className = 'quotes-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>Alias</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Producto</th>
          <th>Entrega</th>
          <th>ARS/kg</th>
          <th>Pago</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    recent.forEach(q => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      const dateStr = q.created_at
        ? new Date(q.created_at).toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' })
        : '‚Äî';
      tr.innerHTML = `
        <td class="quote-number">${q.quote_number ?? '‚Äî'}</td>
        <td class="text-small text-muted">${q.alias || '‚Äî'}</td>
        <td>${dateStr}</td>
        <td>${q.client?.name ?? '‚Äî'}</td>
        <td>${q.product?.name ?? '‚Äî'}</td>
        <td>${q.delivery_term ?? '‚Äî'}</td>
        <td class="num">$${Math.round(q.price_per_kg_ars ?? 0).toLocaleString('es-AR')}</td>
        <td class="text-small">${q.payment_term_label ?? '‚Äî'}</td>
        <td><span class="status-badge ${q.status}">${q.status === 'confirmed' ? 'Confirmada' : 'Borrador'}</span></td>
      `;
      tr.addEventListener('click', () => { window.location.href = 'history-local.html'; });
      tbody.appendChild(tr);
    });
    container.innerHTML = '';
    container.appendChild(table);
  }

  init();
</script>

</body>
</html>
